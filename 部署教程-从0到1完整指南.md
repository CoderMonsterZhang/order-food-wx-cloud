# 餐饮点餐小程序 - 从0到1完整部署教程

本教程将指导你从零开始部署和运行这个餐饮点餐小程序项目。

---

## 📋 目录

1. [环境准备](#1-环境准备)
2. [小程序账号注册](#2-小程序账号注册)
3. [获取项目代码](#3-获取项目代码)
4. [安装微信开发者工具](#4-安装微信开发者工具)
5. [创建和配置云开发环境](#5-创建和配置云开发环境)
6. [修改项目配置](#6-修改项目配置)
7. [创建数据库集合](#7-创建数据库集合)
8. [进入管理后台](#8-进入管理后台)
9. [上传和部署云函数](#9-上传和部署云函数)
10. [配置数据库权限](#10-配置数据库权限)
11. [运行和测试](#11-运行和测试)
12. [常见问题解决](#12-常见问题解决)

---

## 1. 环境准备

### 1.1 必需软件和账号

在开始之前，请确保你已经准备好以下内容：

- ✅ **微信账号**（用于注册小程序）
- ✅ **微信开发者工具**（开发小程序必需）
- ✅ **电脑操作系统**：Windows 7+ / macOS 10.13+ / Linux（推荐 Ubuntu）
- ✅ **网络连接**（需要访问微信服务器）

### 1.2 硬件要求

- 内存：至少 4GB（推荐 8GB 以上）
- 硬盘：至少 2GB 可用空间
- 显示器：分辨率至少 1366×768

---

## 2. 小程序账号注册

### 2.1 注册小程序账号

1. 访问 [微信公众平台](https://mp.weixin.qq.com/)
2. 点击右上角"立即注册"
3. 选择"小程序"
4. 按照提示填写邮箱、密码等信息完成注册
5. 登录小程序后台，完成账号信息填写和认证（个人账号无需认证即可开发）

### 2.2 获取 AppID

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入"开发" → "开发管理" → "开发设置"
3. 复制你的 **AppID**（类似：`wxxxxxxxxxxxxxxxxx`）
4. 保存好这个 AppID，后续配置需要用到

---

## 3. 获取项目代码

### 3.1 方式一：使用 Git（推荐）

如果你已经安装了 Git：

```bash
# 克隆项目到本地
git clone [项目地址]
cd orderFood-wxCloud
```

### 3.2 方式二：直接下载

1. 访问项目仓库
2. 点击"Download ZIP"下载项目压缩包
3. 解压到本地目录（例如：`D:\code\orderFood-wxCloud`）

---

## 4. 安装微信开发者工具

### 4.1 下载开发者工具

1. 访问 [微信开发者工具下载页面](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html)
2. 根据你的操作系统选择对应版本下载
3. 下载完成后运行安装程序

### 4.2 安装和登录

1. 按照安装向导完成安装
2. 打开微信开发者工具
3. 使用微信扫码登录（需要使用注册小程序的微信账号扫码）

---

## 5. 创建和配置云开发环境

### 5.1 在开发者工具中打开项目

1. 打开微信开发者工具
2. 点击"+"或"项目" → "新建项目"
3. 填写项目信息：
   - **项目名称**：餐饮点餐小程序（可自定义）
   - **目录**：选择项目代码所在文件夹（例如：`D:\code\orderFood-wxCloud`）
   - **AppID**：填入你刚才获取的 AppID
   - **开发模式**：小程序
4. 点击"新建"打开项目

> ⚠️ **注意**：如果项目中有 `project.config.json` 文件，AppID 会自动读取，如果没有则手动填写。

### 5.2 开通云开发

1. 在开发者工具顶部菜单，点击"云开发"
2. 如果首次使用，会提示开通云开发
3. 点击"开通"按钮
4. 按照提示完成云开发环境创建：
   - **环境名称**：填写环境名称（例如：`production` 或 `dev`）
   - **环境 ID**：系统会自动生成，格式类似 `cloud1-xxxxx`
   - 选择套餐（开发阶段选择免费版即可）

### 5.3 获取云环境 ID

开通云开发后，在云开发控制台顶部可以看到你的**环境 ID**（例如：`cloud1-2g7lbemveb48a7ce`）

> 💡 **提示**：请复制这个环境 ID，后续配置中会多次用到。

---

## 6. 修改项目配置

现在需要将项目中的配置替换成你的实际信息。

### 6.1 修改小程序入口文件

**文件路径**：`miniprogram/app.js`

找到第 18 行：

```javascript
wx.cloud.init({
  env: '填写你的环境ID',
  traceUser: true,
})
```

将 `'填写你的环境ID'` 替换为你的云环境 ID，例如：

```javascript
wx.cloud.init({
  env: 'cloud1-2g7lbemveb48a7ce',
  traceUser: true,
})
```

### 6.2 修改所有云函数配置文件

需要修改以下云函数中的环境 ID（每个云函数的 `index.js` 文件）：

| 云函数目录 | 文件路径 | 需要修改的行 |
|-----------|---------|-------------|
| login | `cloudfunctions/login/index.js` | 第 5 行 |
| getCategory | `cloudfunctions/getCategory/index.js` | 第 4 行 |
| doBuy | `cloudfunctions/doBuy/index.js` | 第 4 行 |
| pay | `cloudfunctions/pay/index.js` | 第 3 行 |
| pay_success | `cloudfunctions/pay_success/index.js` | 第 5 行 |
| get_code | `cloudfunctions/get_code/index.js` | 第 4 行 |
| getPhoneNumber | `cloudfunctions/getPhoneNumber/index.js` | 第 5 行 |
| getUserList | `cloudfunctions/getUserList/index.js` | 第 5 行 |
| printBack | `cloudfunctions/printBack/index.js` | 第 5 行 |
| printManage | `cloudfunctions/printManage/index.js` | 第 8 行 |

**修改方法**：

在每个云函数的 `index.js` 文件中，找到类似这样的代码：

```javascript
cloud.init({
  env: '填写你的环境ID'
})
```

替换为：

```javascript
cloud.init({
  env: '你的云环境ID'  // 例如：'cloud1-2g7lbemveb48a7ce'
})
```

> 💡 **提示**：可以使用编辑器的"查找和替换"功能批量替换所有 `'填写你的环境ID'` 为你的实际环境 ID。

### 6.3 修改项目配置文件（可选）

**文件路径**：`project.config.json`

检查第 79 行的 `appid` 是否与你的 AppID 一致：

```json
{
  "appid": "wx57595aaf3f7c3344",  // 改为你的 AppID
  ...
}
```

如果不一致，请修改为你的 AppID。

---

## 7. 创建数据库集合

### 7.1 打开云开发控制台

1. 在微信开发者工具中，点击顶部"云开发"按钮
2. 在弹出的控制台中，点击左侧"数据库"菜单

### 7.2 创建数据库集合

需要创建以下 6 个集合（点击"+"按钮创建）：

| 集合名称 | 说明 |
|---------|------|
| **user** | 用户表（存储用户信息和余额） |
| **menu** | 菜品分类表 |
| **goods** | 菜品表 |
| **order** | 订单表（点餐订单和充值订单） |
| **recharge** | 充值套餐表 |
| **freeBuy** | 免单记录表（注意：代码中使用的是 freeBuy，不是 miandan） |

> ⚠️ **重要**：集合名称必须完全一致，区分大小写！

### 7.3 创建步骤

对每个集合执行以下操作：

1. 点击数据库页面右上角的"+"按钮
2. 输入集合名称（例如：`user`）
3. 点击"确定"
4. 重复以上步骤，创建所有 6 个集合

> 💡 **提示**：
> - **admin** 集合会在首次设置管理员密码时自动创建，无需手动创建
> - **user**、**order**、**freeBuy** 集合的数据会在使用时自动创建，无需手动添加

---

## 8. 进入管理后台

项目内置了完整的管理后台功能，所有数据（菜品分类、菜品、充值套餐等）都可以通过管理后台来添加和管理，无需手动在数据库控制台操作。

### 8.1 进入管理后台的方法

1. **运行小程序**（参考步骤 11）
2. 在微信开发者工具的模拟器中，点击底部"我的"标签，进入个人中心页面
3. **在页面右下角空白区域连续快速点击 5 次**（1秒内完成）
4. 会弹出密码输入框：
   - **首次使用**：会提示"设置管理员密码"，输入至少6位密码后点击"设置"
   - **后续使用**：会提示"管理员登录"，输入之前设置的管理员密码后点击"登录"
5. 密码验证成功后，会自动跳转到管理后台页面

> ⚠️ **重要提示**：
> - 首次设置的管理员密码请务必记住，后续登录管理后台需要使用
> - 如果忘记密码，可以在数据库控制台的 `admin` 集合中删除记录，重新设置

### 8.2 管理后台功能说明

管理后台包含以下功能模块：

| 功能模块 | 说明 |
|---------|------|
| **菜品管理** | 添加、编辑、删除菜品，设置菜品分类 |
| **会员管理** | 查看会员列表，管理会员信息 |
| **订单管理** | 查看和处理订单，更新订单状态 |
| **充值选项管理** | 设置充值套餐和赠送规则 |
| **公告管理** | 设置小程序公告信息 |
| **桌码管理** | 管理桌号信息（如果使用桌号功能） |
| **店铺设置** | 设置店铺基本信息 |
| **修改密码** | 修改管理员登录密码 |
| **打印机管理** | 配置小票打印机（如果使用） |

### 8.3 初始化数据建议

首次进入管理后台后，建议按以下顺序设置数据：

1. **设置店铺信息**：店铺设置 → 填写店铺名称、联系方式等
2. **添加菜品分类**：菜品管理 → 添加分类（如：热菜、凉菜、主食、饮品等）
3. **添加菜品**：菜品管理 → 添加菜品，设置价格、图片等
4. **设置充值套餐**：充值选项管理 → 添加充值套餐和赠送规则
5. **设置公告**：公告管理 → 添加欢迎公告或优惠信息（可选）

> 💡 **提示**：所有数据都可以通过管理后台随时添加和修改，无需重启小程序。

---

## 9. 上传和部署云函数

### 9.1 需要上传的云函数列表

本项目包含以下云函数，需要全部上传：

1. **login** - 用户登录获取 openid
2. **getCategory** - 获取菜品分类
3. **doBuy** - 执行购买/下单操作
4. **pay** - 支付相关（如果使用微信支付）
5. **pay_success** - 支付成功回调
6. **get_code** - 获取验证码
7. **getPhoneNumber** - 获取手机号
8. **getUserList** - 获取用户列表（管理后台用）
9. **printBack** - 打印机回调
10. **printManage** - 打印机管理

### 9.2 上传云函数步骤

对每个云函数执行以下操作：

1. 在微信开发者工具的左侧文件树中，找到 `cloudfunctions` 文件夹
2. 展开文件夹，找到云函数目录（例如：`login`）
3. **右键点击**云函数目录
4. 选择菜单：**"上传并部署：云端安装依赖"**
5. 等待上传完成（控制台会显示进度）
6. 重复以上步骤，上传所有云函数

> ⚠️ **注意**：
> - 必须选择"上传并部署：云端安装依赖"，这样云函数会自动安装 npm 依赖
> - 上传过程可能需要几分钟，请耐心等待
> - 如果上传失败，请检查网络连接和云开发环境是否正常

### 9.3 验证云函数部署

1. 在云开发控制台，点击左侧"云函数"菜单
2. 查看云函数列表，确认所有云函数都已成功部署
3. 每个云函数的"状态"应该显示为"正常"

---

## 10. 配置数据库权限

为了数据安全，需要为每个数据库集合设置合适的权限。

### 10.1 打开权限设置

1. 在云开发控制台，点击左侧"数据库"菜单
2. 选择需要设置权限的集合
3. 点击集合名称右侧的"权限设置"按钮（或点击集合后在上方找到权限设置）

### 10.2 设置各集合权限

按照以下配置为每个集合设置权限：

| 集合名称 | 权限设置 | 说明 |
|---------|---------|------|
| **user** | 仅创建者可读写 | 用户只能读写自己的数据 |
| **menu** | 所有用户可读，仅创建者可写 | 所有人可查看分类，只有管理员可修改 |
| **goods** | 所有用户可读，仅创建者可写 | 所有人可查看菜品，只有管理员可修改 |
| **order** | 仅创建者可读写 | 用户只能查看自己的订单 |
| **recharge** | 所有用户可读，仅创建者可写 | 所有人可查看套餐，只有管理员可修改 |
| **freeBuy** | 仅创建者可读写 | 用户只能查看自己的免单记录 |

### 10.3 权限设置方法

1. 点击"权限设置"
2. 选择对应的权限选项
3. 点击"确定"保存

> 💡 **提示**：开发阶段可以将所有集合设置为"所有用户可读可写"以便测试，正式上线前务必修改为合适的权限。

---

## 11. 运行和测试

### 11.1 编译项目

1. 在微信开发者工具中，点击顶部工具栏的"编译"按钮（或按快捷键 `Ctrl+B` / `Cmd+B`）
2. 等待编译完成
3. 如果编译成功，会在模拟器中显示小程序界面

### 11.2 检查控制台

1. 查看开发者工具底部的"控制台"面板
2. 检查是否有错误信息
3. 如果看到环境 ID 相关的错误，请检查步骤 6 中的配置是否正确

### 11.3 功能测试

按照以下流程测试核心功能：

#### 测试 1：用户登录
1. 打开小程序，查看是否能正常加载
2. 检查控制台是否成功获取 openid
3. 查看 `user` 集合，确认已自动创建用户记录

#### 测试 2：进入管理后台
1. 点击底部"我的"标签，进入个人中心
2. 在页面右下角空白区域连续快速点击 5 次
3. 首次会弹出"设置管理员密码"弹窗
4. 输入至少6位密码（例如：`123456`）并点击"设置"
5. 验证是否能成功跳转到管理后台页面

#### 测试 3：通过管理后台添加数据
1. 在管理后台中，点击"店铺设置"，填写店铺基本信息
2. 点击"菜品管理"，添加菜品分类（如：热菜、凉菜等）
3. 添加一些测试菜品
4. 点击"充值选项管理"，添加充值套餐
5. 返回小程序首页，验证数据是否正常显示

#### 测试 4：查看菜品和分类
1. 在首页查看是否能显示刚才添加的菜品分类
2. 查看是否能显示添加的菜品
3. 测试点击分类切换功能

#### 测试 5：充值功能
1. 点击底部"充值"标签
2. 查看是否能显示刚才添加的充值套餐
3. 尝试选择一个套餐（测试环境可能无法实际支付）

#### 测试 6：点餐功能
1. 在首页添加商品到购物车
2. 点击结算（需要先有余额或免单机会）
3. 如果余额不足，系统会提示充值

### 11.4 真机预览

1. 点击开发者工具顶部工具栏的"预览"按钮
2. 使用微信扫码在手机上预览
3. 在手机上测试各项功能

> ⚠️ **注意**：真机预览需要使用注册小程序的微信账号扫码。

---

## 12. 常见问题解决

### Q1: 编译时报错 "请使用 2.2.3 或以上的基础库以使用云能力"

**原因**：基础库版本太低

**解决方法**：
1. 在开发者工具右上角，点击"详情"
2. 在"本地设置"中，将"调试基础库"版本设置为 2.2.3 或更高
3. 重新编译

### Q2: 提示 "环境ID不存在" 或 "找不到环境"

**原因**：环境 ID 配置错误

**解决方法**：
1. 检查步骤 5.3 中获取的环境 ID 是否正确
2. 检查步骤 6 中所有配置文件的修改是否正确
3. 确认云开发环境已正常开通

### Q3: 云函数上传失败

**可能原因和解决方法**：

1. **网络问题**
   - 检查网络连接
   - 尝试重新上传

2. **依赖安装失败**
   - 检查云函数的 `package.json` 文件是否存在
   - 查看控制台错误信息，根据提示解决

3. **云开发环境异常**
   - 在云开发控制台检查环境状态
   - 尝试重新开通云开发环境

### Q4: 数据库查询返回空数据

**解决方法**：
1. 检查数据库集合名称是否正确（区分大小写）
2. 通过管理后台添加数据（参考步骤 8）
3. 检查数据库权限设置是否正确
4. 查看控制台错误信息

### Q5: 用户登录失败

**解决方法**：
1. 检查 `login` 云函数是否已成功上传
2. 检查云函数中的环境 ID 配置
3. 查看控制台错误信息
4. 确认 AppID 配置正确

### Q6: 充值或下单时提示余额不足

**解决方法**：
1. 这是正常现象，需要先充值
2. 可以在数据库控制台的 `user` 集合中，手动修改用户的 `balance` 字段进行测试
3. 或在 `freeBuy` 集合中添加免单记录进行测试

### Q7: 图片无法显示

**解决方法**：
1. 检查图片 URL 是否正确
2. 如果使用云存储，需要在云开发控制台 → 存储中上传图片
3. 确保图片 URL 可以公开访问

### Q8: 小程序页面显示空白

**解决方法**：
1. 查看控制台是否有 JavaScript 错误
2. 检查网络请求是否正常
3. 检查云函数是否都已成功部署
4. 检查数据库权限设置

---

## 📝 后续步骤

完成以上步骤后，你的小程序已经可以正常运行了。接下来可以：

1. **通过管理后台添加数据**：
   - 添加菜品分类和菜品
   - 设置充值套餐
   - 配置店铺信息
   - 设置公告等

2. **测试完整功能**：
   - 测试充值功能
   - 测试点餐下单流程
   - 测试订单管理
   - 测试会员管理

3. **配置其他功能**（可选）：
   - 配置小票打印机（如果使用）
   - 设置桌码管理（如果使用桌号功能）
   - 配置微信支付（如果需要在线支付）

4. **上传代码提交审核**：开发完成后，可以在开发者工具中上传代码，提交微信审核

---

## 🎉 完成！

恭喜你！现在你的餐饮点餐小程序已经成功部署并可以运行了。

如果遇到其他问题，请：
1. 查看微信开发者工具的控制台错误信息
2. 查看云开发控制台的日志
3. 参考项目 README.md 中的常见问题部分

**祝你使用愉快，生意兴隆！** 🎊

---

## 📚 相关资源

- [微信小程序官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [微信云开发文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html)
- [微信开发者工具下载](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html)
- [微信公众平台](https://mp.weixin.qq.com/)

---

**最后更新时间**：2024年

**文档版本**：v1.0

